<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©tha-Sync Pro</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f4f7f6; --gray: #607d8b; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; padding-bottom: 30px; }
        
        .nav-bar { position: sticky; top: 0; width: 100%; background: white; display: flex; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 12px 0; color: var(--gray); font-weight: bold; cursor: pointer; font-size: 0.8rem; }
        .nav-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: #f1f8e9; }

        .container { padding: 15px; }
        h1 { color: var(--primary); text-align: center; font-size: 1.1rem; margin: 15px 0; text-transform: uppercase; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; border-top: 4px solid var(--primary); }
        .group-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: block; }
        
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        label { flex: 1; font-size: 0.95rem; color: #333; margin-right: 10px; }
        input[type="number"], input[type="text"] { width: 90px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        input[type="checkbox"] { width: 30px; height: 30px; accent-color: var(--primary); }

        .btn { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-config-toggle { background: #eceff1; color: #455a64; border: none; padding: 10px; width: 100%; border-radius: 8px; font-size: 0.75rem; margin-bottom: 15px; font-weight: bold; }
        
        /* Historique */
        .hist-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.85rem; border-left: 4px solid var(--gray); }
        .hist-date { font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .hist-data { color: #444; white-space: pre-wrap; line-height: 1.4; }

        .config-panel { display: none; background: #fff; border: 2px dashed var(--primary); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.85rem; }
        .btn-remove { color: var(--danger); background: none; border: none; font-weight: bold; cursor: pointer; padding: 5px; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div id="nav-quot" class="nav-item active" onclick="switchTab('quot')">üìÖ Quotidien</div>
        <div id="nav-anal" class="nav-item" onclick="switchTab('anal')">üß™ Analyses</div>
        <div id="nav-hist" class="nav-item" onclick="switchTab('hist')">üìú Historique</div>
    </div>

    <div id="loading-overlay">
        <div style="font-size: 1.5rem; color: var(--primary); margin-bottom: 10px;">‚öôÔ∏è</div>
        <div id="loading-text">Synchronisation...</div>
    </div>

    <div id="app-content" class="container" style="display:none;">
        <h1 id="current-tab-name">Quotidien</h1>
        
        <div id="tab-saisie">
            <button class="btn-config-toggle" onclick="toggleConfig()">üõ† CONFIGURER / SUPPRIMER DES POINTS</button>
            <div id="config-panel" class="config-panel">
                <h3 style="margin-top:0; font-size: 1rem;">Ajouter un point</h3>
                <input type="text" id="cfg-bloc" placeholder="Nom du Bloc (ex: Moteur)">
                <input type="text" id="cfg-champ" placeholder="Nom du Champ (ex: Heures)">
                <select id="cfg-format">
                    <option value="number">Valeur (Nombre)</option>
                    <option value="checkbox">Case √† cocher</option>
                    <option value="text">Texte (Commentaire)</option>
                </select>
                <button class="btn" onclick="ajouterPointVersGoogle()" style="background:#1976d2;">Ajouter au Cloud</button>
                <div id="delete-list" style="margin-top:15px;"></div>
            </div>
            <div id="fields-container"></div>
            <button id="btn-send" class="btn" onclick="envoyerDonnees()">üíæ ENREGISTRER LE RAPPORT</button>
        </div>

        <div id="tab-historique" style="display:none;">
            <button class="btn-config-toggle" onclick="chargerHistorique()">üîÑ Rafra√Æchir l'historique</button>
            <div id="hist-container"></div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwloOAuNVSmZTcCGkjvpvtFgAGyHADowOJD6Dl8NPVnmqxdcL7bsVmShJ9d7wu9NNEwOg/exec";
        let activeTab = 'quot';
        let configData = [];

        async function init() {
            try {
                const resp = await fetch(SCRIPT_URL);
                configData = await resp.json();
                localStorage.setItem('metha_config_backup', JSON.stringify(configData));
            } catch (e) {
                configData = JSON.parse(localStorage.getItem('metha_config_backup')) || [];
            }
            render();
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        }

        function render() {
            const container = document.getElementById('fields-container');
            const delContainer = document.getElementById('delete-list');
            container.innerHTML = "";
            delContainer.innerHTML = "<strong>Supprimer des points :</strong>";
            
            if(activeTab === 'hist') return;

            document.getElementById('current-tab-name').innerText = activeTab === 'quot' ? "üìÖ Relev√©s Quotidiens" : "üß™ Analyses Labo";
            const filtered = configData.filter(i => i.type === activeTab);
            const groups = [...new Set(filtered.map(i => i.bloc))];

            groups.forEach(groupName => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<span class="group-title">${groupName}</span>`;
                filtered.filter(i => i.bloc === groupName).forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'row';
                    const inputHTML = item.format === 'checkbox' 
                        ? `<input type="checkbox" class="data-input" data-group="${item.bloc}" data-label="${item.champ}">`
                        : `<input type="${item.format}" class="data-input" data-group="${item.bloc}" data-label="${item.champ}" placeholder="0">`;
                    row.innerHTML = `<label>${item.champ}</label>${inputHTML}`;
                    card.appendChild(row);

                    const delItem = document.createElement('div');
                    delItem.className = 'config-item';
                    delItem.innerHTML = `<span>${item.bloc} > ${item.champ}</span><button class="btn-remove" onclick="supprimerPoint('${item.bloc}', '${item.champ}')">‚ùå</button>`;
                    delContainer.appendChild(delItem);
                });
                container.appendChild(card);
            });
        }

        async function chargerHistorique() {
            const container = document.getElementById('hist-container');
            container.innerHTML = "Chargement des derni√®res donn√©es...";
            try {
                // On ajoute un param√®tre √† l'URL pour dire au script qu'on veut les donn√©es
                const resp = await fetch(SCRIPT_URL + "?getLogs=true");
                const logs = await resp.json();
                container.innerHTML = "";
                
                // On filtre pour n'avoir que les rapports de type "anal" (Analyses)
                logs.filter(l => l.rapport === 'anal').reverse().slice(0, 15).forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'hist-item';
                    let details = "";
                    for (let [key, value] of Object.entries(log)) {
                        if(!['rapport','date','action'].includes(key)) details += `${key}: ${value}\n`;
                    }
                    div.innerHTML = `<div class="hist-date">üìÖ ${log.date}</div><div class="hist-data">${details}</div>`;
                    container.appendChild(div);
                });
            } catch (e) {
                container.innerHTML = "Impossible de charger l'historique. V√©rifiez votre connexion.";
            }
        }

        async function synchroniserConfig() {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "saveConfig", config: configData }) });
                localStorage.setItem('metha_config_backup', JSON.stringify(configData));
                render();
            } catch (e) { alert("Erreur synchro"); }
            finally { document.getElementById('loading-overlay').style.display = 'none'; }
        }

        async function ajouterPointVersGoogle() {
            const bloc = document.getElementById('cfg-bloc').value;
            const champ = document.getElementById('cfg-champ').value;
            const format = document.getElementById('cfg-format').value;
            if(!bloc || !champ) return;
            configData.push({ type: activeTab, bloc, champ, format });
            await synchroniserConfig();
        }

        async function supprimerPoint(bloc, champ) {
            if(confirm("Supprimer ce point ?")) {
                configData = configData.filter(i => !(i.type === activeTab && i.bloc === bloc && i.champ === champ));
                await synchroniserConfig();
            }
        }

        async function envoyerDonnees() {
            const btn = document.getElementById('btn-send');
            let payload = { action: "data", rapport: activeTab, date: new Date().toLocaleString() };
            document.querySelectorAll('.data-input').forEach(i => {
                payload[i.dataset.group + "_" + i.dataset.label] = i.type === 'checkbox' ? i.checked : i.value;
            });
            btn.disabled = true;
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ Envoy√© !");
                document.querySelectorAll('.data-input').forEach(i => i.type === 'checkbox' ? i.checked = false : i.value = "");
            } catch (e) { alert("‚ùå Erreur"); } 
            finally { btn.disabled = false; }
        }

        function switchTab(t) {
            activeTab = t;
            document.getElementById('nav-quot').classList.toggle('active', t === 'quot');
            document.getElementById('nav-anal').classList.toggle('active', t === 'anal');
            document.getElementById('nav-hist').classList.toggle('active', t === 'hist');
            
            if(t === 'hist') {
                document.getElementById('tab-saisie').style.display = 'none';
                document.getElementById('tab-historique').style.display = 'block';
                document.getElementById('current-tab-name').innerText = "üìú Historique Analyses";
                chargerHistorique();
            } else {
                document.getElementById('tab-saisie').style.display = 'block';
                document.getElementById('tab-historique').style.display = 'none';
                render();
            }
        }

        function toggleConfig() {
            const p = document.getElementById('config-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        init();
    </script>
</body>
</html>