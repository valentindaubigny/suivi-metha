<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©tha-Sync Pro</title>
    <style>
        :root { --primary: #2e7d32; --bg: #f4f7f6; --gray: #607d8b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 80px; }
        
        /* Navigation */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 15px 0; color: var(--gray); font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); border-top: 3px solid var(--primary); background: #f1f8e9; }

        /* Contenu */
        h1 { color: var(--primary); text-align: center; font-size: 1.2rem; margin: 10px 0; text-transform: uppercase; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; border-top: 4px solid var(--primary); }
        .group-title { font-weight: bold; color: var(--primary); margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: block; }
        
        .row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        label { flex: 1; font-size: 0.95rem; color: #333; margin-right: 10px; }
        input[type="number"], input[type="text"] { width: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; }
        input[type="checkbox"] { width: 30px; height: 30px; accent-color: var(--primary); }

        /* Boutons */
        .btn { background: var(--primary); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn:disabled { background: #ccc; }
        .btn-config-toggle { background: #eceff1; color: #455a64; border: none; padding: 8px; width: 100%; border-radius: 8px; font-size: 0.75rem; margin-bottom: 15px; font-weight: bold; }
        
        /* Panel Config */
        .config-panel { display: none; background: #fff; border: 2px dashed var(--primary); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .config-panel input, .config-panel select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 1.5rem; color: var(--primary); margin-bottom: 10px;">‚öôÔ∏è</div>
        <div id="loading-text">Synchronisation...</div>
    </div>

    <div id="app-content" style="display:none;">
        <h1 id="current-tab-name">Quotidien</h1>
        
        <button class="btn-config-toggle" onclick="toggleConfig()">üõ† CONFIGURER LES POINTS DE CONTR√îLE</button>
        
        <div id="config-panel" class="config-panel">
            <h3 style="margin-top:0; font-size: 1rem;">Ajouter un point</h3>
            <input type="text" id="cfg-bloc" placeholder="Nom du Bloc (ex: Moteur)">
            <input type="text" id="cfg-champ" placeholder="Nom du Champ (ex: Heures)">
            <select id="cfg-format">
                <option value="number">Valeur (Nombre)</option>
                <option value="checkbox">Case √† cocher (Checklist)</option>
                <option value="text">Texte (Commentaire)</option>
            </select>
            <button class="btn" onclick="ajouterPointVersGoogle()" style="background:#1976d2;">Enregistrer sur le Cloud</button>
            <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">Note : Les modifications sont partag√©es sur tous vos appareils.</p>
        </div>

        <div id="fields-container"></div>
        
        <button id="btn-send" class="btn" onclick="envoyerDonnees()">üíæ ENREGISTRER LE RAPPORT</button>
    </div>

    <div class="nav-bar">
        <div id="nav-quot" class="nav-item active" onclick="switchTab('quot')">üìÖ Quotidien</div>
        <div id="nav-anal" class="nav-item" onclick="switchTab('anal')">üß™ Analyses</div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwloOAuNVSmZTcCGkjvpvtFgAGyHADowOJD6Dl8NPVnmqxdcL7bsVmShJ9d7wu9NNEwOg/exec";
        
        let activeTab = 'quot';
        let configData = [];

        // 1. Chargement initial
        async function init() {
            try {
                const resp = await fetch(SCRIPT_URL);
                configData = await resp.json();
                localStorage.setItem('metha_config_backup', JSON.stringify(configData));
            } catch (e) {
                console.log("Mode hors-ligne");
                configData = JSON.parse(localStorage.getItem('metha_config_backup')) || [];
            }
            render();
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
        }

        function render() {
            const container = document.getElementById('fields-container');
            container.innerHTML = "";
            document.getElementById('current-tab-name').innerText = activeTab === 'quot' ? "üìÖ Relev√©s Quotidiens" : "üß™ Analyses Labo";

            const filtered = configData.filter(i => i.type === activeTab);
            const groups = [...new Set(filtered.map(i => i.bloc))];

            if(filtered.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999;'>Aucun point configur√©. Utilisez le bouton Configuration ci-dessus.</p>";
                return;
            }

            groups.forEach(groupName => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<span class="group-title">${groupName}</span>`;
                
                filtered.filter(i => i.bloc === groupName).forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'row';
                    const inputHTML = item.format === 'checkbox' 
                        ? `<input type="checkbox" class="data-input" data-group="${item.bloc}" data-label="${item.champ}">`
                        : `<input type="${item.format}" class="data-input" data-group="${item.bloc}" data-label="${item.champ}" placeholder="0">`;
                    
                    row.innerHTML = `<label>${item.champ}</label>${inputHTML}`;
                    card.appendChild(row);
                });
                container.appendChild(card);
            });
        }

        async function ajouterPointVersGoogle() {
            const bloc = document.getElementById('cfg-bloc').value;
            const champ = document.getElementById('cfg-champ').value;
            const format = document.getElementById('cfg-format').value;

            if(!bloc || !champ) { alert("Remplissez tous les champs"); return; }

            const newPoint = { type: activeTab, bloc: bloc, champ: champ, format: format };
            configData.push(newPoint);

            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-text').innerText = "Mise √† jour du Cloud...";

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: "saveConfig", config: configData })
                });
                toggleConfig();
                render();
            } catch (e) {
                alert("Erreur de sauvegarde");
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        async function envoyerDonnees() {
            const btn = document.getElementById('btn-send');
            let payload = { action: "data", rapport: activeTab, date: new Date().toLocaleString() };
            
            document.querySelectorAll('.data-input').forEach(i => {
                const val = i.type === 'checkbox' ? i.checked : i.value;
                payload[i.dataset.group + "_" + i.dataset.label] = val;
            });

            btn.disabled = true;
            btn.innerText = "‚è≥ Envoi...";

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ Rapport envoy√© avec succ√®s !");
            } catch (e) {
                alert("‚ùå Erreur d'envoi");
            } finally {
                btn.disabled = false;
                btn.innerText = "üíæ ENREGISTRER LE RAPPORT";
            }
        }

        function switchTab(t) {
            activeTab = t;
            document.getElementById('nav-quot').classList.toggle('active', t === 'quot');
            document.getElementById('nav-anal').classList.toggle('active', t === 'anal');
            render();
        }

        function toggleConfig() {
            const p = document.getElementById('config-panel');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
        }

        init();
    </script>
</body>
</html>